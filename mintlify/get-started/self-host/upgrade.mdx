---
title: Upgrade
---

import TerminalDockerRunVolume from '/snippets/install/terminal-docker-run-volume.mdx';

<Warning>
**BEFORE YOU UPGRADE**

- Never run multiple containers on the same data directory. Stop and remove the old one first to avoid corruption.
- Back up your metadata before upgrading. Youâ€™ll need it if you ever downgrade.
- Verify the upgrade in a test environment first.

</Warning>

## Back up Data

### External PostgreSQL Metadata (Recommended)

If [`--pg`](/reference/command-line#--pg-string) is specified, the metadata will be stored in the specified external PostgreSQL database. Below shows how to back up and restore the Bytebase metadata, let's assume the metadata is stored in `metadb`.

#### Back up the metadata

```text
pg_dump -h <<host>> -p <<port>> -U <<user>> -d metadb > metadb.sql
```

#### Restore Option 1 - Restore to the same `metadb`

##### Step 1 - Restore metadata to a temporary db

Create a new db `metadb_new`:

```text
psql -h <<host>> -p <<port>> -U <<user>> metadb -c "CREATE DATABASE metadb_new"
```

Restore metadata to the new db:

```text
psql -h <<host>> -p <<port>> -U <<user>> metadb_new < metadb.sql
```

##### Step 2 - Swap the existing metadata db with the temporary db

<Tip>

You need to first stop Bytebase otherwise its connection to the metadata db will prevent renaming the database.

Also, you can not rename the connecting database so you need to connect to the PostgreSQL instance using a different database like `postgres`.

</Tip>

Rename existing `metadb` to `metadb_old`:

```text
psql -h <<host>> -p <<port>> -U <<user>> postgres -c "ALTER DATABASE metadb RENAME TO metadb_old"
```

Rename `metadb_new` to the `metadb`, which will serve as the new metadata db:

```text
psql -h <<host>> -p <<port>> -U <<user>> postgres -c "ALTER DATABASE metadb_new RENAME TO metadb"
```

##### Step 3 - Drop the old metadata db

Restart Bytebase and verify the metadata is restored properly. Afterwards, you can drop the old database:

```text
psql -h <<host>> -p <<port>> -U <<user>> postgres -c "DROP DATABASE metadb_old"
```

#### Restore Option 2 - Restore to a different database `metadb2`


##### Step 1 - Restore metadata to `metadb2`

Create a new db `metadb2`:

```text
psql -h <<host>> -p <<port>> -U <<user>> metadb -c "CREATE DATABASE metadb2"
```

Restore metadata to the new db:

```text
psql -h <<host>> -p <<port>> -U <<user>> metadb2 < metadb.sql
```

##### Step 2 - Drop the old metadata db

Restart Bytebase and verify the metadata is restored properly. Afterwards, you can drop the old database:

```text
psql -h <<host>> -p <<port>> -U <<user>> postgres -c "DROP DATABASE metadb"
```

### Embedded PostgreSQL Metadata

If [External PostgreSQL](/get-started/self-host/external-postgres/) is not configured, then
Bytebase will store the metadata under the [`--data`](/reference/command-line#--data-directory) directory.
You can back up the `--data` directory or the `pgdata` subfolder.

<Note>

You should periodically back up the entire [`--data`](/reference/command-line#--data-directory) directory if any data is stored there.

If Bytebase is running and not in the [`--readonly`](/reference/command-line#--readonly) mode, and you want to take the backup, then the underlying data volume must support snapshot feature where the entire directory can take a snapshot at the same time, otherwise it may produce a corrupted backup bundle.

</Note>

## Upgrade Process

Take Docker as an example (**follow the below steps exactly**):

1. Stop Bytebase

   ```text
   docker stop bytebase
   docker rm bytebase
   ```

1. ðŸš¨ Back up the Bytebase metadata

   ```bash
   cp -rp ~/.bytebase/data ~/.bytebase/data.bak
   ```

   Above example backs up the metadata stored in the embedded database.
   If you store metadata in the [external PostgreSQL](/get-started/self-host/external-postgres/), you should
   back up that database using the instructions in the "Back up Data" section above.

1. Change version string to 3.9.0

1. Start Bytebase

   <TerminalDockerRunVolume />

